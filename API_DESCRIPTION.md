# Описание методов API #
Все запросы выполняются POST запросом по указанному адресу. В ответ приходит строка с JSON объектом. 
В случае, если нужно отправить объект, следует записать его в JSON и отправить строкой.  
Выделеные *курсивом* параметры необязательны.
Каждый запрос возвращает в ответе логическое значение `success`, обозначающее результат выполнения запроса.
В случае, если запрос вернет ошибку, в ответе также будут присутствовать числовое поле `err_code` и строковое поле `err_cause`.
`err_code` содержит код ошибки. Описание ошибок находится ниже.
`err_cause` содержит текстовое описание проблемы и предназначено больше для человека, нежели для автоматического парсинга.
Если в ходе выполнения запроса возникла ошибка, наличие в ответе полей, кроме `success`, `err_code` и `err_cause` неопределено, если не сказано обратного.
Помимо перечисленных ошибок, каждый метод также может вернуть ошибку с кодом `-1` или `-2`, либо с кодом `0`, что будет означать успех.

## Используемые объекты ##

Пользователь:

| Имя         | Тип    | Описание                              | Пример                             |
| ----------- | ------ | ------------------------------------- | ---------------------------------- |
| id          | int    | Id пользователя                       | `1`                                |
| nickname    | string | Никнейм                               | `"admin"`                          |
| permissions | int    | Битовая маска привелегий пользователя | `7`                                |
| avatar      | string | Название файла аватара                | `"photo.png"`                      |
| channels    | array  | Список доступных пользователю каналов | `[1, 2, 4, 8]`                     |
| *meta*      | *JSON* | *Дополнительная информация*           | *`{ "bio": "Software engineer" }`* |

Канал:

| Имя               | Тип      | Описание                                     | Пример                       |
| ----------------- | -------- | -------------------------------------------- | ---------------------------- |
| id                | int      | ID канала                                    | `2`                          |
| name              | string   | Название канала                              | `"IU9-23 chat"`              |
| owner_id          | int      | ID создателя канала                          | `1`                          |
| listeners_ids     | array    | ID пользователей, имеющих доступ к каналу    | `[1, 2, 3, 4, 6]`            |
| last_message_id   | int      | ID последнего сообщения в канале             | `"21"`                       |
| last_message_time | unixtime | Время отправки последнего сообщения в канале | `1565446412`                 |
| *meta*            | *JSON*   | *Дополнительная информация*                  | *`{ "about": "Cool chat" }`* |

Сообщение:

| Имя        | Тип      | Описание                    | Пример          |
| ---------- | -------- | --------------------------- | --------------- |
| id         | int      | Id сообщения                | `20`            |
| author_id  | string   | ID автора                   | `1`             |
| message    | string   | Текст сообщения             | `Hello, users!` |
| time       | unixtime | Время отправления           | `1565446412`    |
| channel_id | int      | ID канала                   | `2`             |
| *meta*     | *JSON*   | *Дополнительная информация* | *`{}`*          |

## Возвращаемые ошибки ##

| Код | Описание                                                  | Пример сообщения                                            |
| --- | --------------------------------------------------------- | ----------------------------------------------------------- |
| 0   | Успех (Может не использоваться)                           | Success                                                     |
| -1  | Неизвестная ошибка                                        | Something weird happened                                    |
| -2  | Другая ошибка                                             | ¯\\\_(ツ)\_\/¯                                              |
| -3  | Неизвестный метод API                                     | Unknown API method (send_messaeg)                           |
| 1   | Ошибка в количестве аргументов (Не был передан аргумент)  | Argument not found (token)                                  |
| 2   | Ошибка в типе аргументов                                  | Wrong argument type (count). Expected int, but found string |
| 3   | Данный объект уже существует (пользователь, канал и т.д.) | User with the same nickname already exist                   |
| 4   | Неверный пароль (только при авторизации)                  | Password is incorrect                                       |
| 5   | Неверный токен (мог истечь срок действия)                 | Wrong access token                                          |
| 6   | Доступ запрещен (не хватает прав)                         | Access denied                                               |
| 7   | Искомый объект не существует                              | User with id 1 does not exist                               |

## Методы авторизации ##
### Регистрация ###
**/api/register**

Регистрирует нового пользователя

Параметры:

| Имя      | Тип    | Описание | Пример        |
| -------- | ------ | -------- | ------------- |
| login    | string | Логин    | `"admin"`     |
| password | string | Пароль   | `"azerty123"` |

Возможные ошибки:

| Код | Описание                       |
| --- | ------------------------------ |
| 1   | Ошибка в количестве аргументов |
| 2   | Ошибка в типе аргументов       |
| 3   | Данный объект уже существует   |

***
### Авторизация ###
**/api/auth**

Авторизация.

Параметры:

| Имя      | Тип    | Описание | Пример        |
| -------- | ------ | -------- | ------------- |
| login    | string | Логин    | `"admin"`     |
| password | string | Пароль   | `"azerty123"` |

Ответ:

| Имя   | Тип    | Описание    | Пример           |
| ----- | ------ | ----------- | ---------------- |
| token | string | Ключ сессии | `"aS31L42n21hD"` |

Возможные ошибки:

| Код | Описание                       |
| --- | ------------------------------ |
| 1   | Ошибка в количестве аргументов |
| 2   | Ошибка в типе аргументов       |
| 4   | Неверный пароль                |

## Методы работы с пользователями ##
### Получить информацию о пользователе ###
**/api/get_user**

Получить объект с информацией о пользователе.

Параметры:

| Имя | Тип | Описание        | Пример |
| --- | --- | --------------- | ------ |
| id  | int | ID пользователя | `1`    |

Ответ:

| Имя  | Тип  | Описание                                                  | Пример                            |
| ---- | ---- | --------------------------------------------------------- | --------------------------------- |
| user | JSON | Объект данных о пользователе (см. "Используемые объекты") | `{"id":1,"nickname":"admin",...}` |

Возможные ошибки:

| Код | Описание                       |
| --- | ------------------------------ |
| 1   | Ошибка в количестве аргументов |
| 2   | Ошибка в типе аргументов       |
| 7   | Искомый объект не существует   |

***
### Добавить пользователя к каналу ###
**/api/add_to_channel**

Добавить канал к списку каналов, к которым может подключаться пользователь

Параметры:

| Имя        | Тип    | Описание        | Пример           |
| ---------- | ------ | --------------- | ---------------- |
| token      | string | Ключ сессии     | `"aS31L42n21hD"` |
| user_id    | int    | ID пользователя | `1`              |
| channel_id | int    | ID канала       | `2`              |

Возможные ошибки:

| Код | Описание                                  |
| --- | ----------------------------------------- |
| 1   | Ошибка в количестве аргументов            |
| 2   | Ошибка в типе аргументов                  |
| 5   | Неверный токен (мог истечь срок действия) |
| 6   | Доступ запрещен (не хватает прав)         |
| 7   | Искомый объект не существует              |

***
### Удалить пользователя из канала ###
**/api/remove_from_channel**

Удвлить канал из списка каналов, к которым может подключаться пользователь.
Если пользователь не имеет доступа к этому каналу метод все-равно вернет успех.

Параметры:

| Имя        | Тип    | Описание        | Пример           |
| ---------- | ------ | --------------- | ---------------- |
| token      | string | Ключ сессии     | `"aS31L42n21hD"` |
| user_id    | int    | ID пользователя | `1`              |
| channel_id | int    | ID канала       | `2`              |

Возможные ошибки:

| Код | Описание                                  |
| --- | ----------------------------------------- |
| 1   | Ошибка в количестве аргументов            |
| 2   | Ошибка в типе аргументов                  |
| 5   | Неверный токен (мог истечь срок действия) |
| 6   | Доступ запрещен (не хватает прав)         |
| 7   | Искомый объект не существует              |


***
### Изменить аватар пользователю ###
**/api/change_avatar**

Изменить аватар у пользователя. Чтобы удалить аватар следует указать пустую строку.
Если такого файла не существует, то метод все равно вернет успех.
Загрузка аватара производится независимо от этого метода.

Параметры:

| Имя     | Тип    | Описание         | Пример           |
| ------- | ------ | ---------------- | ---------------- |
| token   | string | Ключ сессии      | `"aS31L42n21hD"` |
| user_id | int    | ID пользователя  | `1`              |
| avatar  | string | Имя нового файла | `"photo.png"`    |

Возможные ошибки:

| Код | Описание                                  |
| --- | ----------------------------------------- |
| 1   | Ошибка в количестве аргументов            |
| 2   | Ошибка в типе аргументов                  |
| 5   | Неверный токен (мог истечь срок действия) |
| 6   | Доступ запрещен (не хватает прав)         |
| 7   | Искомый объект не существует              |

***
### Изменить метаданные пользователя ###
**/api/change_meta**

Изменить метаданные у пользователя.

Параметры:

| Имя     | Тип    | Описание         | Пример                       |
| ------- | ------ | ---------------- | ---------------------------- |
| token   | string | Ключ сессии      | `"aS31L42n21hD"`             |
| user_id | int    | ID пользователя  | `1`                          |
| meta    | string | Новые метаданные | `{ "bio": "BMSTU student" }` |

Возможные ошибки:

| Код | Описание                                  |
| --- | ----------------------------------------- |
| 1   | Ошибка в количестве аргументов            |
| 2   | Ошибка в типе аргументов                  |
| 5   | Неверный токен (мог истечь срок действия) |
| 6   | Доступ запрещен (не хватает прав)         |
| 7   | Искомый объект не существует              |

## Методы работы с каналами ##
### Получить информацию о канале ###
**/api/get_channel**

Получить данные о канале.

Параметры:

| Имя | Тип | Описание  | Пример |
| --- | --- | --------- | ------ |
| id  | int | ID канала | `2`    |

Ответ:

| Имя     | Тип  | Описание                                            | Пример                              |
| ------- | ---- | --------------------------------------------------- | ----------------------------------- |
| channel | JSON | Объект данных о канале (см. "Используемые объекты") | `{"id":1,"name":"IU9-23 chat",...}` |

Возможные ошибки:

| Код | Описание                       |
| --- | ------------------------------ |
| 1   | Ошибка в количестве аргументов |
| 2   | Ошибка в типе аргументов       |
| 7   | Искомый объект не существует   |

***
### Создать новый канал ###
**/api/create_channel**

Создать новый канал с указанным названием. 
Создатель автоматически будет добавлен в созданный канал.

Параметры:

| Имя          | Тип    | Описание        | Пример           |
| ------------ | ------ | --------------- | ---------------- |
| token        | string | Ключ сессии     | `"aS31L42n21hD"` |
| channel_name | string | Название канала | `"IU9-23 chat"`  |

Возможные ошибки:

| Код | Описание                                  |
| --- | ----------------------------------------- |
| 1   | Ошибка в количестве аргументов            |
| 2   | Ошибка в типе аргументов                  |
| 5   | Неверный токен (мог истечь срок действия) |
| 6   | Доступ запрещен (не хватает прав)         |
| 7   | Искомый объект не существует              |

***
### Удалить канал ###
**/api/delete_channel**

Удалить канал. 

Параметры:

| Имя        | Тип    | Описание    | Пример           |
| ---------- | ------ | ----------- | ---------------- |
| token      | string | Ключ сессии | `"aS31L42n21hD"` |
| channel_id | int    | ID канала   | `2`              |

Возможные ошибки:

| Код | Описание                                  |
| --- | ----------------------------------------- |
| 1   | Ошибка в количестве аргументов            |
| 2   | Ошибка в типе аргументов                  |
| 5   | Неверный токен (мог истечь срок действия) |
| 6   | Доступ запрещен (не хватает прав)         |
| 7   | Искомый объект не существует              |

## Методы работы с чатами ##
### Получить историю сообщений канала ###
**/api/get_messages**

Получить указанное количество сообщений из канала. 
Сообщения считаются считая с конца, с пропуском `offset` последних сообщений.  
Например, в чате есть сообщения с id: 1, 2, 3 ... 20. Сообщение 20 - последнее. Тогда:  

| offset | count | Результат              |
| ------ | ----- | ---------------------- |
| 0      | 5     | `[16, 17, 18, 19, 20]` |
| 1      | 5     | `[15, 16, 17, 18, 19]` |
| 2      | 5     | `[14, 15, 16, 17, 18]` |
| 18     | 5     | `[1, 2]`               |

Параметры:

| Имя        | Тип    | Описание                       | Пример           |
| ---------- | ------ | ------------------------------ | ---------------- |
| token      | string | Ключ сессии                    | `"aS31L42n21hD"` |
| channel_id | int    | ID канала                      | `2`              |
| offset     | int    | Смещение с конца               | `0`              |
| count      | int    | Ожидаемое количество сообщений | `20`             |

Ответ:

| Имя      | Тип   | Описание                          | Пример                                             |
| -------- | ----- | --------------------------------- | -------------------------------------------------- |
| count    | int   | Количество передаваемых сообщений | `20`                                               |
| messages | array | Массив объектов сообщений         | `[{id: 16, author_id: 1, ...}, {...}, {...}, ...]` |

Возможные ошибки:

| Код | Описание                                  |
| --- | ----------------------------------------- |
| 1   | Ошибка в количестве аргументов            |
| 2   | Ошибка в типе аргументов                  |
| 5   | Неверный токен (мог истечь срок действия) |
| 6   | Доступ запрещен (не хватает прав)         |
| 7   | Искомый объект не существует              |

***
### Отправить сообщение ###
**/api/send_message**

Отправить текстовое сообщение.

Параметры:

| Имя        | Тип    | Описание        | Пример           |
| ---------- | ------ | --------------- | ---------------- |
| token      | string | Ключ сессии     | `"aS31L42n21hD"` |
| channel_id | int    | ID канала       | `2`              |
| message    | string | Текст сообщения | `"Hi, users!"`   |

Возможные ошибки:

| Код | Описание                                  |
| --- | ----------------------------------------- |
| 1   | Ошибка в количестве аргументов            |
| 2   | Ошибка в типе аргументов                  |
| 5   | Неверный токен (мог истечь срок действия) |
| 6   | Доступ запрещен (не хватает прав)         |
| 7   | Искомый объект не существует              |

***
### Отправить long-poll запрос ###
**/api/listen**

**DEPRECATED**

## Прочие
### Получить ключ шифрования ###
**/api/get_public_cipher**

Получить публичный ключ для шифрования передаваемых данных. 
Зашифрованные данные должны отправляться вместе с полученным идентификатором ключа.

Параметры:

|  Имя  |  Тип  | Описание | Пример |
| :---: | :---: | :------: | :----: |
|   -   |   -   |    -     |   -    |

Ответ:

| Имя   | Тип    | Описание            | Пример           |
| ----- | ------ | ------------------- | ---------------- |
| key   | string | Публичный ключ      | `"dAW41Sa4pQmf"` |
| ident | int    | Идентификатор ключа | `21`             |
