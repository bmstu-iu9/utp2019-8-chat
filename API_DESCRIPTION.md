# Описание методов API #
Все запросы выполняются POST запросом по указанному адресу. 
В ответ приходит строка с JSON объектом. 
В случае, если нужно отправить объект, следует записать его в JSON и отправить строкой.  
Выделеные *курсивом* параметры необязательны.

## Используемые объекты ##

Пользователь:

| Имя | Тип | Описание | Пример |
| - | - | - | - |
| id | int | Id пользователя | `1` |
| nickname | string | Никнейм | `"admin"` |
| permissions | int | Битовая маска привелегий пользователя | `7` |
| avatar | string | Название файла аватара | `"photo.png"` |
| channels | array | Список доступных пользователю каналов | `[1, 2, 4, 8]` |
| *meta* | *JSON* | *Дополнительная информация* | *`{ "bio": "Software engineer" }`* |

Канал:

| Имя | Тип | Описание | Пример |
| - | - | - | - |
| id | int | ID канала | `2` |
| name | string | Название канала | `"IU9-23 chat"` |
| owner_id | int | ID создателя канала | `1` |
| listeners_ids | array | ID пользователей, имеющих доступ к каналу | `[1, 2, 3, 4, 6]` |
| last_message_id | int | ID последнего сообщения в канале | `"21"` |
| last_message_time | unixtime | Время отправки последнего сообщения в канале | `1565446412` |
| *meta* | *JSON* | *Дополнительная информация* | *`{ "about": "Cool chat" }`* |

Сообщение:

| Имя | Тип | Описание | Пример |
| - | - | - | - |
| id | int | Id сообщения | `20` |
| author_id | string | ID автора | `1` |
| message | string | Текст сообщения | `Hello, users!` |
| time | unixtime | Время отправления | `1565446412` |
| channel_id | int | ID канала | `2` |
| *meta* | *JSON* | *Дополнительная информация* | *`{}`* |


## Методы авторизации ##
### Регистрация ###
**/api/register**

Регистрирует нового пользователя

Параметры:

| Имя | Тип | Описание | Пример |
| - | - | - | - |
| login | string | Логин | `"admin"` |
| password | string | Пароль | `"azerty123"` |

Ответ:

| Имя | Тип | Описание | Пример |
| - | - | - | - |
| success | bool | Результат | `true`/`false` |
| *err_cause* | *string* | *Причина ошибки* | `"User with the same nickname already exist"` |

***
### Авторизация ###
**/api/auth**

Авторизация.

Параметры:

| Имя | Тип | Описание | Пример |
| - | - | - | - |
| login | string | Логин | `"admin"` |
| password | string | Пароль | `"azerty123"` |

Ответ:

| Имя | Тип | Описание | Пример |
| - | - | - | - |
| success | bool | Результат | `true`/`false` |
| *token* | *string* | *Ключ сессии* | `"aS31L42n21hD"` |
| *err_cause* | *string* | *Причина ошибки* | `"Password is incorrect"` |

## Методы работы с пользователями ##
### Получить информацию о пользователе ###
**/api/get_user**

Получить объект с информацией о пользователе.

Параметры:

| Имя | Тип | Описание | Пример |
| - | - | - | - |
| id | int | ID пользователя | `1` |

Ответ:

| Имя | Тип | Описание | Пример |
| - | - | - | - |
| success | bool | Результат | `true`/`false` |
| *user* | *JSON* | *Объект данных о пользователе (см. "Используемые объекты")* | `{"id":1,"nickname":"admin",...}` |
| *err_cause* | *string* | *Причина ошибки* | `"User with id 1 does not exist"` |

***
### Добавить пользователя к каналу ###
**/api/add_to_channel**

Добавить канал к списку каналов, к которым может подключаться пользователь

Параметры:

| Имя | Тип | Описание | Пример |
| - | - | - | - |
| token | string | Ключ сессии | `"aS31L42n21hD"` |
| user_id | int | ID пользователя | `1` |
| channel_id | int | ID канала | `2` |

Ответ:

| Имя | Тип | Описание | Пример |
| - | - | - | - |
| success | bool | Результат | `true`/`false` |
| *err_cause* | *string* | *Причина ошибки* | `"Channel with id 2 does not exist"` |

***
### Удалить пользователя из канала ###
**/api/remove_from_channel**

Удвлить канал из списка каналов, к которым может подключаться пользователь.
Если пользователь не имеет доступа к этому каналу метод все-равно вернет успех.

Параметры:

| Имя | Тип | Описание | Пример |
| - | - | - | - |
| token | string | Ключ сессии | `"aS31L42n21hD"` |
| user_id | int | ID пользователя | `1` |
| channel_id | int | ID канала | `2` |

Ответ:

| Имя | Тип | Описание | Пример |
| - | - | - | - |
| success | bool | Результат | `true`/`false` |
| *err_cause* | *string* | *Причина ошибки* | `"Channel with id 2 does not exist"` |

***
### Изменить аватар пользователю ###
**/api/change_avatar**

Изменить аватар у пользователя. Чтобы удалить аватар следует указать пустую строку.
Если такого файла не существует, то метод все равно вернет успех.
Загрузка аватара производится независимо от этого метода.

Параметры:

| Имя | Тип | Описание | Пример |
| - | - | - | - |
| token | string | Ключ сессии | `"aS31L42n21hD"` |
| user_id | int | ID пользователя | `1` |
| avatar | string | Имя нового файла | `"photo.png"` |

Ответ:

| Имя | Тип | Описание | Пример |
| - | - | - | - |
| success | bool | Результат | `true`/`false` |
| *err_cause* | *string* | *Причина ошибки* | `"User with id 1 does not exist"` |

***
### Изменить метаданные пользователя ###
**/api/change_avatar**

Изменить аватар у пользователя. Чтобы удалить аватар следует указать пустую строку.
Если такого файла не существует, то метод все равно вернет успех.
Загрузка аватара производится независимо от этого метода.

Параметры:

| Имя | Тип | Описание | Пример |
| - | - | - | - |
| token | string | Ключ сессии | `"aS31L42n21hD"` |
| user_id | int | ID пользователя | `1` |
| meta | string | Новые метаданные | `{ "bio": "BMSTU student" }` |

Ответ:

| Имя | Тип | Описание | Пример |
| - | - | - | - |
| success | bool | Результат | `true`/`false` |
| *err_cause* | *string* | *Причина ошибки* | `"User with id 1 does not exist"` |

## Методы работы с каналами ##
### Получить информацию о канале ###
**/api/get_channel**

Получить данные о канале.

Параметры:

| Имя | Тип | Описание | Пример |
| - | - | - | - |
| id | int | ID канала | `2` |

Ответ:

| Имя | Тип | Описание | Пример |
| - | - | - | - |
| success | bool | Результат | `true`/`false` |
| *channel* | *JSON* | *Объект данных о канале (см. "Используемые объекты")* | `{"id":1,"name":"IU9-23 chat",...}` |
| *err_cause* | *string* | *Причина ошибки* | `"Channel with id 2 does not exist"` |

***
### Создать новый канал ###
**/api/create_channel**

Создать новый канал с указанным названием. 
Создатель автоматически будет добавлен в созданный канал.

Параметры:

| Имя | Тип | Описание | Пример |
| - | - | - | - |
| token | string | Ключ сессии | `"aS31L42n21hD"` |
| channel_name | string | Название канала | `"IU9-23 chat"` |

Ответ:

| Имя | Тип | Описание | Пример |
| - | - | - | - |
| success | bool | Результат | `true`/`false` |
| *err_cause* | *string* | *Причина ошибки* | `"Bad token"` |

***
### Удалить канал ###
**/api/delete_channel**

Удалить канал. 

Параметры:

| Имя | Тип | Описание | Пример |
| - | - | - | - |
| token | string | Ключ сессии | `"aS31L42n21hD"` |
| channel_id | int | ID канала | `2` |

Ответ:

| Имя | Тип | Описание | Пример |
| - | - | - | - |
| success | bool | Результат | `true`/`false` |
| *err_cause* | *string* | *Причина ошибки* | `"Channel with id 2 does not exist"` |

## Методы работы с чатами ##
### Получить историю сообщений канала ###
**/api/get_messages**

Получить указанное количество сообщений из канала. 
Сообщения считаются считая с конца, с пропуском `offset` последних сообщений.  
Например, в чате есть сообщения с id: 1, 2, 3 ... 20. Сообщение 20 - последнее. Тогда:  

| offset | count | Результат |
| - | - | - |
| 0 | 5 | `[16, 17, 18, 19, 20]` |
| 1 | 5 | `[15, 16, 17, 18, 19]` |
| 2 | 5 | `[14, 15, 16, 17, 18]` |
| 18 | 5 | `[1, 2]` |

Параметры:

| Имя | Тип | Описание | Пример |
| - | - | - | - |
| token | string | Ключ сессии | `"aS31L42n21hD"` |
| channel_id | int | ID канала | `2` |
| offset | int | Смещение с конца | `0` |
| count | int | Ожидаемое количество сообщений | `20` |

Ответ:

| Имя | Тип | Описание | Пример |
| - | - | - | - |
| success | bool | Результат | `true`/`false` |
| *count* | *int* | *Количество передаваемых сообщений* | `20` |
| *messages* | *array* | *Массив объектов сообщений* | `[{id: 16, author_id: 1, ...}, {...}, {...}, ...]` |
| *err_cause* | *string* | *Причина ошибки* | `"Channel with id 2 does not exist"` |

***
### Отправить сообщение ###
**/api/send_message**

Отправить текстовое сообщение.

Параметры:

| Имя | Тип | Описание | Пример |
| - | - | - | - |
| token | string | Ключ сессии | `"aS31L42n21hD"` |
| channel_id | int | ID канала | `2` |
| message | string | Текст сообщения | "Hi, users!" |

Ответ:

| Имя | Тип | Описание | Пример |
| - | - | - | - |
| success | bool | Результат | `true`/`false` |
| *err_cause* | *string* | *Причина ошибки* | `"Channel with id 2 does not exist"` |

***
### Отправить long-poll запрос ###
**/api/send_message**

Отправить запрос, ответ на который придет при появлении нового сообщения в чате.
`last_msg` - ID сообщения, после которого будуд ожидаться новые. 
Если последнее сообщение в чате - 20, а в `last_msg` передать 18, то ответ придет немедленно и будет содержать
сообщение 19.

Параметры:

| Имя | Тип | Описание | Пример |
| - | - | - | - |
| token | string | Ключ сессии | `"aS31L42n21hD"` |
| channel_id | int | ID канала | `2` |
| last_msg | int | ID последнего принятого сообщения | "20" |

Ответ:

| Имя | Тип | Описание | Пример |
| - | - | - | - |
| success | bool | Результат | `true`/`false` |
| message | JSON | Объект сообщения | `{id: 16, author_id: 1, ...}` |
| *err_cause* | *string* | *Причина ошибки* | `"Channel with id 2 does not exist"` |
